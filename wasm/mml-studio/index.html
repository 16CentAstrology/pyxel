<!DOCTYPE html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pyxel MML Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style type="text/tailwindcss">
      @layer components {
        .page {
          @apply bg-gray-50 dark:bg-gray-900 h-full text-gray-800 dark:text-gray-100 antialiased;
        }
        .container {
          @apply mx-auto p-6 max-w-4xl;
        }
        .card {
          @apply bg-white dark:bg-gray-800 shadow-sm p-6 border border-gray-200 dark:border-gray-700;
        }
        .input {
          @apply bg-white dark:bg-gray-900 px-3 py-2 border border-gray-300 focus:border-indigo-500 dark:border-gray-600 rounded-lg outline-none w-full placeholder:text-gray-400 text-sm;
        }
        .toggle {
          @apply bg-gray-50 dark:bg-gray-900 px-2 py-1 border border-slate-500 rounded-md w-14 font-medium text-gray-700 dark:text-gray-300 text-xs;
        }
        .toggle.active {
          @apply bg-slate-600 text-white;
        }
        .link {
          @apply text-indigo-600 hover:text-indigo-700 dark:hover:text-indigo-300 dark:text-indigo-400 underline underline-offset-2;
        }
      }
    </style>
  </head>
  <body class="page">
    <main class="container">
      <h1 class="mb-2 font-semibold text-2xl tracking-tight">
        Pyxel MML Studio
      </h1>

      <div
        class="flex sm:flex-row flex-col items-start sm:items-center mb-4 min-w-0"
      >
        <!-- Control buttons and info link -->
        <div class="flex flex-col mr-0 sm:mr-4 min-w-[100px]">
          <div class="flex flex-row gap-x-2 mb-2">
            <button
              type="button"
              class="toggle"
              data-action="play"
              data-state="false"
              onmousedown="handleButtonPress(this)"
            >
              PLAY
            </button>
            <button
              type="button"
              class="toggle"
              data-action="stop"
              data-state="false"
              onmousedown="handleButtonPress(this)"
            >
              STOP
            </button>
            <button
              type="button"
              class="toggle active"
              data-action="loop"
              data-state="true"
              onmousedown="handleButtonPress(this)"
            >
              LOOP
            </button>
          </div>
          <a
            href="https://github.com/kitao/pyxel/wiki/MML"
            target="_blank"
            rel="noopener noreferrer"
            class="block sm:self-center mb-2 text-s link"
          >
            Pyxel MML Guide
          </a>
        </div>

        <!-- Pyxel screen -->
        <div
          class="flex flex-grow items-center mt-2 sm:mt-0 p-0 w-full sm:w-auto h-24 card"
        >
          <iframe
            id="pyxel-screen"
            src="pyxel-screen.html"
            class="border-0 w-full h-full"
          ></iframe>
        </div>
      </div>

      <div class="flex flex-col space-y-2">
        <!-- Channel 1 editing UI -->
        <div>
          <div class="flex items-center space-x-4 mb-2">
            <label for="ch1" class="text-xl">CH1</label>
            <div class="flex items-center space-x-2">
              <button
                type="button"
                class="toggle"
                data-action="solo1"
                data-state="false"
                onmousedown="handleButtonPress(this)"
              >
                SOLO
              </button>
              <input type="hidden" id="solo1" name="solo1" value="0" />
              <button
                type="button"
                class="toggle"
                data-action="mute1"
                data-state="false"
                onmousedown="handleButtonPress(this)"
              >
                MUTE
              </button>
              <input type="hidden" id="mute1" name="mute1" value="0" />
            </div>
          </div>
          <textarea
            id="ch1"
            rows="2"
            class="font-mono input"
            placeholder="o4v15cdefrgb+..."
            oninput="handleMmlInput(this)"
            onkeydown="handleMmlKeydown(event, this)"
          ></textarea>
        </div>

        <!-- Channel 2 editing UI -->
        <div>
          <div class="flex items-center space-x-4 mb-2">
            <label for="ch2" class="text-xl">CH2</label>
            <div class="flex items-center space-x-2">
              <button
                type="button"
                class="toggle"
                data-action="solo2"
                data-state="false"
                onmousedown="handleButtonPress(this)"
              >
                SOLO
              </button>
              <input type="hidden" id="solo2" name="solo2" value="0" />
              <button
                type="button"
                class="toggle"
                data-action="mute2"
                data-state="false"
                onmousedown="handleButtonPress(this)"
              >
                MUTE
              </button>
              <input type="hidden" id="mute2" name="mute2" value="0" />
            </div>
          </div>
          <textarea
            id="ch2"
            rows="2"
            class="font-mono input"
            placeholder="t120l8..."
            oninput="handleMmlInput(this)"
            onkeydown="handleMmlKeydown(event, this)"
          ></textarea>
        </div>

        <!-- Channel 3 editing UI -->
        <div>
          <div class="flex items-center space-x-4 mb-2">
            <label for="ch3" class="text-xl">CH3</label>
            <div class="flex items-center space-x-2">
              <button
                type="button"
                class="toggle"
                data-action="solo3"
                data-state="false"
                onmousedown="handleButtonPress(this)"
              >
                SOLO
              </button>
              <input type="hidden" id="solo3" name="solo3" value="0" />
              <button
                type="button"
                class="toggle"
                data-action="mute3"
                data-state="false"
                onmousedown="handleButtonPress(this)"
              >
                MUTE
              </button>
              <input type="hidden" id="mute3" name="mute3" value="0" />
            </div>
          </div>
          <textarea
            id="ch3"
            rows="2"
            class="font-mono input"
            placeholder="o4v15cdefrgb+..."
            oninput="handleMmlInput(this)"
            onkeydown="handleMmlKeydown(event, this)"
          ></textarea>
        </div>

        <!-- Channel 4 editing UI -->
        <div>
          <div class="flex items-center space-x-4 mb-2">
            <label for="ch4" class="text-xl">CH4</label>
            <div class="flex items-center space-x-2">
              <button
                type="button"
                class="toggle"
                data-action="solo4"
                data-state="false"
                onmousedown="handleButtonPress(this)"
              >
                SOLO
              </button>
              <input type="hidden" id="solo4" name="solo4" value="0" />
              <button
                type="button"
                class="toggle"
                data-action="mute4"
                data-state="false"
                onmousedown="handleButtonPress(this)"
              >
                MUTE
              </button>
              <input type="hidden" id="mute4" name="mute4" value="0" />
            </div>
          </div>
          <textarea
            id="ch4"
            rows="2"
            class="font-mono input"
            placeholder="t120l8..."
            oninput="handleMmlInput(this)"
            onkeydown="handleMmlKeydown(event, this)"
          ></textarea>
        </div>
      </div>
      <div class="mt-2"></div>

      <div
        class="flex sm:flex-row flex-col items-start sm:items-end space-x-0 sm:space-x-4 space-y-4 sm:space-y-0"
      >
        <!-- URL -->
        <div class="flex-grow">
          <label for="url" class="block mb-1 text-xl">URL</label>
          <div id="url" class="h-20 font-mono break-all input">
            <a
              href="http://example.com/XXXXXXXXXXXXXXXX"
              ,
              target="_blank"
              rel="noopener noreferrer"
              class="link"
            >
              http://example.com/XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
            </a>
          </div>
        </div>

        <!-- QR Code -->
        <div class="flex-shrink-0">
          <img
            src="https://placehold.co/100x100/000000/ffffff?text=QR"
            alt="QR Code"
            class="border border-gray-300 dark:border-gray-600 rounded-md min-w-[80px] min-h-[80px]"
          />
        </div>
      </div>
    </main>

    <script>
      function setButtonStyle(btn, isActive) {
        btn.classList.toggle("active", isActive);
      }

      function handleButtonPress(btn) {
        const pyxelScreen = document.getElementById("pyxel-screen");
        const action = btn.dataset.action;
        const varName = "js_" + action;
        let isActive;

        if (action === "play" || action === "stop") {
          isActive = true;
          setButtonStyle(btn, true);
          setTimeout(() => {
            setButtonStyle(btn, false);
            pyxelScreen.contentWindow[varName] = false;
          }, 150);
        } else {
          btn.dataset.state = btn.dataset.state !== "true";
          isActive = btn.dataset.state === "true";
          setButtonStyle(btn, isActive);
        }

        pyxelScreen.contentWindow[varName] = isActive;

        if (action === "play") {
          pyxelScreen.contentWindow.resetPyxel();
        }
      }

      function handleMmlInput(textarea) {
        const id = textarea.id;
        if (id && id.startsWith("ch")) {
          const pyxelScreen = document.getElementById("pyxel-screen");
          pyxelScreen.contentWindow[`js_${id}_mml`] = textarea.value;
        }
      }

      function handleMmlKeydown(e, textarea) {
        if (e.key === "Enter") {
          e.preventDefault();
          const pyxelScreen = document.getElementById("pyxel-screen");
          pyxelScreen.contentWindow.resetPyxel();
        }
      }

      window.addEventListener("DOMContentLoaded", () => {
        const pyxelScreen = document.getElementById("pyxel-screen");
        pyxelScreen.addEventListener("load", () => {
          document.querySelectorAll("button[data-action]").forEach((btn) => {
            const action = btn.dataset.action;
            const varName = "js_" + action;
            const isActive = btn.dataset.state === "true";
            pyxelScreen.contentWindow[varName] = isActive;
          });
        });
      });
    </script>
  </body>
</html>
