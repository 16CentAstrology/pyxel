<!DOCTYPE html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pyxel Web Launcher</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body
    class="h-full bg-gray-50 text-gray-800 antialiased dark:bg-gray-900 dark:text-gray-100"
  >
    <main class="mx-auto max-w-3xl p-6">
      <header class="mb-8">
        <h1 class="text-2xl font-semibold tracking-tight">
          Pyxel Web Launcher
        </h1>
        <p class="mt-2 text-sm text-gray-600 dark:text-gray-300">
          Launcher tool for the WebAssembly version of
          <a
            class="text-indigo-600 dark:text-indigo-400 underline decoration-dashed underline-offset-2 hover:text-indigo-700 dark:hover:text-indigo-300"
            href="https://github.com/kitao/pyxel"
            >Pyxel</a
          >
        </p>
      </header>

      <section
        class="rounded-2xl border border-gray-200 bg-white p-6 shadow-sm dark:border-gray-700 dark:bg-gray-800"
      >
        <div class="grid grid-cols-1 gap-5">
          <div class="grid gap-2">
            <label for="startup-file" class="text-sm font-medium"
              >Startup File URL on GitHub</label
            >
            <input
              id="startup-file"
              type="text"
              size="60"
              class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm outline-none ring-0 placeholder:text-gray-400 focus:border-indigo-500 dark:border-gray-600 dark:bg-gray-900"
              placeholder="https://github.com/USER/REPO/blob/BRANCH/PATH/TO/APP.pyxapp"
            />
            <ul
              class="mt-1 list-disc space-y-1 pl-5 text-xs text-gray-600 dark:text-gray-400"
            >
              <li>
                Startup file type should be
                <code
                  class="rounded bg-gray-100 px-1 py-0.5 text-[10px] dark:bg-gray-800"
                  >.pyxapp</code
                >
                or
                <code
                  class="rounded bg-gray-100 px-1 py-0.5 text-[10px] dark:bg-gray-800"
                  >.py</code
                >, <br />
                e.g.
                <a
                  class="text-indigo-600 underline decoration-dotted underline-offset-2 dark:text-indigo-400"
                  href="https://github.com/kitao/pyxel/blob/main/python/pyxel/examples/megaball.pyxapp"
                >
                  https://github.com/kitao/pyxel/blob/main/python/pyxel/examples/megaball.pyxapp
                </a>
              </li>
            </ul>
          </div>

          <div class="flex items-center gap-2">
            <label for="virtual-gamepad" class="text-sm font-medium"
              >Enable Virtual Gamepad</label
            >
            <input
              id="virtual-gamepad"
              type="checkbox"
              checked
              class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 dark:border-gray-600"
            />
          </div>

          <div class="grid gap-2">
            <label for="additional-packages" class="text-sm font-medium"
              >Additional Packages</label
            >
            <input
              id="additional-packages"
              type="text"
              size="60"
              class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm outline-none focus:border-indigo-500 dark:border-gray-600 dark:bg-gray-900"
              placeholder="numpy,matplotlib"
            />
            <ul
              class="mt-1 list-disc space-y-1 pl-5 text-xs text-gray-600 dark:text-gray-400"
            >
              <li>
                Only
                <a
                  class="text-indigo-600 underline decoration-dotted underline-offset-2 dark:text-indigo-400"
                  href="https://pyodide.org/en/stable/usage/packages-in-pyodide.html"
                  >packages supported by Pyodide</a
                >
                can be used.
              </li>
              <li>
                If there are multiple packages, separate them with commas like
                <code
                  class="rounded bg-gray-100 px-1 py-0.5 text-[10px] dark:bg-gray-800"
                  >a,b,c</code
                >.
              </li>
            </ul>
          </div>

          <div class="grid gap-2">
            <label for="mml-list" class="text-sm font-medium">MML List</label>
            <input
              id="mml-list"
              type="text"
              size="60"
              class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm outline-none focus:border-indigo-500 dark:border-gray-600 dark:bg-gray-900"
              placeholder="T120 L8 CDEFGAB; T140 L16 C<C>G<G>"
            />
            <ul
              class="mt-1 list-disc space-y-1 pl-5 text-xs text-gray-600 dark:text-gray-400"
            >
              <li>
                Separate multiple entries with
                <code
                  class="rounded bg-gray-100 px-1 py-0.5 text-[10px] dark:bg-gray-800"
                  >;</code
                >
              </li>
            </ul>
          </div>

          <div class="grid gap-2 pt-2">
            <span class="text-sm font-medium">Application Launch URL</span>
            <a
              id="launch-url"
              href=""
              target="_blank"
              class="break-all text-indigo-600 hover:text-indigo-700 dark:text-indigo-400 dark:hover:text-indigo-300 font-semibold"
            ></a>
          </div>
        </div>
      </section>

      <section class="mt-8">
        <p class="mt-4 text-sm text-gray-700 dark:text-gray-300">
          For specific instructions, please refer to
          <a
            class="text-indigo-600 underline decoration-dotted underline-offset-2 dark:text-indigo-400"
            href="https://github.com/kitao/pyxel/blob/main/docs/pyxel-web-en.md"
            >this page</a
          >
          (<a
            class="text-indigo-600 underline decoration-dotted underline-offset-2 dark:text-indigo-400"
            href="https://github.com/kitao/pyxel/blob/main/docs/pyxel-web-ja.md"
            >日本語</a
          >).
        </p>
      </section>
    </main>

    <script>
      function buildLaunchUrl() {
        const mmlList = document.getElementById("mml-list").value;
        if (mmlList) {
          const base64Url = btoa(mmlList)
            .replace(/\+/g, "-")
            .replace(/\//g, "_")
            .replace(/=+$/, "");
          const launchUrlHref = document.getElementById("launch-url");
          launchUrlHref.textContent = launchUrlHref.href =
            "https://kitao.github.io/pyxel/wasm/launcher/?mml=" + base64Url;
          return;
        }

        const startupFile = document.getElementById("startup-file").value;
        const virtualGamepad =
          document.getElementById("virtual-gamepad").checked;
        const additionalPackages = document.getElementById(
          "additional-packages"
        ).value;
        const launchUrlHref = document.getElementById("launch-url");
        launchUrlHref.textContent = launchUrlHref.href = "";

        if (
          !startupFile.startsWith("https://github.com/") ||
          !(startupFile.endsWith(".py") || startupFile.endsWith(".pyxapp")) ||
          additionalPackages.match(/[^a-zA-Z0-9,]/)
        ) {
          return;
        }

        const paths = startupFile.split("/");
        const dottedPath = paths.slice(3, 5).concat(paths.slice(7)).join(".");
        const filePath = dottedPath.split(".").slice(0, -1).join(".");
        const fileExt = dottedPath.split(".").slice(-1)[0];
        var launchUrl = "https://kitao.github.io/pyxel/wasm/launcher/?";
        launchUrl += fileExt === "py" ? "run" : "play";
        launchUrl += "=" + filePath;

        if (virtualGamepad) {
          launchUrl += "&gamepad=enabled";
        }

        if (additionalPackages != "") {
          launchUrl += "&packages=" + additionalPackages;
        }

        launchUrlHref.textContent = launchUrlHref.href = launchUrl;
      }

      document
        .getElementById("startup-file")
        .addEventListener("input", buildLaunchUrl);
      document
        .getElementById("virtual-gamepad")
        .addEventListener("change", buildLaunchUrl);
      document
        .getElementById("additional-packages")
        .addEventListener("input", buildLaunchUrl);
      document
        .getElementById("mml-list")
        .addEventListener("input", buildLaunchUrl);
    </script>
  </body>
</html>
